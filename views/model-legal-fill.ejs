<%- include('partials/header', { title: (template && template.title) ? template.title : 'Legal Document' }) %>

<%
  var schemaArr = (Array.isArray(schema) ? schema : []);
  var valuesObj = (values && typeof values === 'object') ? values : {};
  var prefillObj = (prefill && typeof prefill === 'object') ? prefill : {};

  function s(v) { return (v === undefined || v === null) ? '' : String(v); }
  function keyOf(f) { return (f && f.key) ? String(f.key).trim() : ''; }
  function labelOf(f, k) { return (f && f.label) ? String(f.label) : k; }
  function isReq(f) { return !!(f && f.required); }
  function maxOf(f) {
    if (!f || f.max === undefined || f.max === null) return 0;
    var n = parseInt(f.max, 10);
    return isNaN(n) ? 0 : n;
  }
  function typeOf(f) {
    var t = (f && f.type) ? String(f.type).toLowerCase() : 'text';
    if (!t) t = 'text';
    return t;
  }
  function boolish(v) {
    return v === true || v === 'true' || v === 'on' || v === '1' || v === 1;
  }
  function pickVal(k) {
    if (valuesObj[k] !== undefined && valuesObj[k] !== null) return valuesObj[k];
    if (prefillObj[k] !== undefined && prefillObj[k] !== null) return prefillObj[k];
    return '';
  }

  var sigDataUrlOnFile = (signature && signature.signature_data_url) ? String(signature.signature_data_url) : '';
  var typedOnFile = (signature && signature.typed_name) ? String(signature.typed_name) : '';
%>

<!-- schemaCount: <%= schemaArr.length %> -->

<style>
  .wrap { max-width: 1100px; margin: 0 auto; padding: 22px 16px; }
  .card { background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 18px; }
  .title { font-size: 20px; font-weight: 700; margin: 0 0 10px; }
  .sub { opacity: 0.85; margin: 0 0 14px; line-height: 1.3; }

  .notice { border-radius: 12px; padding: 10px 12px; margin: 10px 0 14px; }
  .notice.error { background: rgba(255,80,80,0.12); border: 1px solid rgba(255,80,80,0.25); }
  .notice.ok { background: rgba(80,255,140,0.10); border: 1px solid rgba(80,255,140,0.22); }

  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

  .field { display: flex; flex-direction: column; gap: 6px; }
  .label { font-size: 12px; opacity: 0.9; }
  .req { color: #ffb3b3; margin-left: 6px; font-size: 11px; }
  .input, .select, .textarea {
    width: 100%;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(0,0,0,0.35);
    color: #fff;
    padding: 10px 10px;
    outline: none;
  }
  .textarea { min-height: 90px; resize: vertical; }

  .row { display: flex; gap: 10px; align-items: center; margin-top: 10px; }
  .divider { height: 1px; background: rgba(255,255,255,0.08); margin: 16px 0; }

  .doc {
    background: rgba(0,0,0,0.22);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 14px;
    padding: 14px;
    overflow: auto;
  }

  .actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 14px; }
  .btn {
    border-radius: 999px;
    padding: 10px 16px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.06);
    color: #fff;
    cursor: pointer;
    text-decoration: none;
  }
  .btn.primary {
    background: linear-gradient(90deg, rgba(255,180,60,0.85), rgba(255,120,40,0.85));
    border: none;
    color: #111;
    font-weight: 700;
  }
  .help { font-size: 12px; opacity: 0.7; margin-top: 6px; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
</style>

<div class="wrap">
  <div class="card">
    <h1 class="title"><%= (template && template.title) ? template.title : 'Legal Document' %></h1>

    <% if (needsResign) { %>
      <div class="notice error">This document was updated since your last signature. Please review and sign the updated version.</div>
    <% } else if (alreadySigned) { %>
      <div class="notice ok">You have already signed the latest version. You may review it again below.</div>
    <% } %>

    <% if (error) { %>
      <div class="notice error"><%= error %></div>
    <% } %>

    <% if (message) { %>
      <div class="notice ok"><%= message %></div>
    <% } %>

    <p class="sub">
      Fill out the required fields below, then sign to generate the executed PDF.
    </p>

    <form method="POST" action="/model/legal/<%= template.slug %>">
      <!-- your POST route requires these -->
      <input type="hidden" name="signature_data_url" value="<%= sigDataUrlOnFile %>">

      <% if (!schemaArr.length) { %>
        <div class="notice error">
          This template has no schema fields (schemaCount is 0). It will appear sign-only.
          Fix is to define fields_json in legal_templates OR rely on server-side defaults for the slug.
        </div>
      <% } %>

      <div class="grid">
        <% schemaArr.forEach(function(f){ 
            var k = keyOf(f);
            if (!k) return;

            var t = typeOf(f);
            var req = isReq(f);
            var mx = maxOf(f);
            var val = pickVal(k);
        %>

          <div class="field">
            <div class="label">
              <%= labelOf(f, k) %>
              <% if (req) { %><span class="req">required</span><% } %>
            </div>

            <% if (t === 'textarea') { %>
              <% if (req && mx > 0) { %>
                <textarea class="textarea" name="<%= k %>" required maxlength="<%= mx %>"><%= s(val) %></textarea>
              <% } else if (req) { %>
                <textarea class="textarea" name="<%= k %>" required><%= s(val) %></textarea>
              <% } else if (mx > 0) { %>
                <textarea class="textarea" name="<%= k %>" maxlength="<%= mx %>"><%= s(val) %></textarea>
              <% } else { %>
                <textarea class="textarea" name="<%= k %>"><%= s(val) %></textarea>
              <% } %>

            <% } else if (t === 'select') { %>
              <select class="select" name="<%= k %>" <% if (req) { %>required<% } %>>
                <option value="">— Select —</option>
                <% (f && Array.isArray(f.options) ? f.options : []).forEach(function(opt){ 
                    var o = s(opt);
                    var sel = (s(val) === o);
                %>
                  <option value="<%= o %>" <% if (sel) { %>selected<% } %>><%= o %></option>
                <% }) %>
              </select>

            <% } else if (t === 'checkbox') { %>
              <div class="row">
                <input type="checkbox" name="<%= k %>" value="1" <% if (boolish(val)) { %>checked<% } %> <% if (req) { %>required<% } %> />
                <div><%= labelOf(f, k) %></div>
              </div>

            <% } else { %>
              <% var inputType = (t === 'email' || t === 'date') ? t : 'text'; %>
              <% if (req && mx > 0) { %>
                <input class="input" type="<%= inputType %>" name="<%= k %>" value="<%= s(val) %>" required maxlength="<%= mx %>">
              <% } else if (req) { %>
                <input class="input" type="<%= inputType %>" name="<%= k %>" value="<%= s(val) %>" required>
              <% } else if (mx > 0) { %>
                <input class="input" type="<%= inputType %>" name="<%= k %>" value="<%= s(val) %>" maxlength="<%= mx %>">
              <% } else { %>
                <input class="input" type="<%= inputType %>" name="<%= k %>" value="<%= s(val) %>">
              <% } %>
            <% } %>

          </div>

        <% }) %>
      </div>

      <div class="divider"></div>

      <div class="field">
        <div class="label">Print Name <span class="req">required</span></div>
        <input class="input" type="text" name="typed_name" value="<%= typedOnFile %>" required maxlength="120">
        <div class="help">
          Your signature on file:
          <span class="mono"><%= signature ? (signature.typed_name || 'On file') : 'Missing' %></span>
        </div>
      </div>

      <div class="row">
        <input type="checkbox" name="agree_to_sign" value="1" required>
        <div>I have read this document and I agree to the terms.</div>
      </div>

      <div class="divider"></div>

      <div class="doc">
        <%- (typeof bodyInlineHtml !== 'undefined' && bodyInlineHtml) ? bodyInlineHtml : (template.body_html || '') %>
      </div>

      <div class="actions">
        <a class="btn" href="/model/legal">Cancel</a>
        <button class="btn primary" type="submit">Sign &amp; Generate PDF</button>
      </div>
    </form>
  </div>
</div>

<%- include('partials/footer') %>
