<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title><%= template ? template.title : 'Executed Legal Document' %></title>
  <style>
    body { font-family: Arial, sans-serif; color:#111; font-size: 12px; }
    .header { border-bottom: 2px solid #111; padding-bottom: 10px; margin-bottom: 14px; }
    .brand { font-size: 16px; font-weight: 700; }
    .meta { margin-top: 4px; color:#333; font-size: 11px; }
    .section { margin: 14px 0; }
    .box { border: 1px solid #111; border-radius: 8px; padding: 10px; }
    .small { font-size: 11px; color:#333; }
    .hr { border-top: 1px solid #ccc; margin: 12px 0; }
    .doc { line-height: 1.5; }
    .doc h1,.doc h2,.doc h3 { margin: 10px 0 6px; }
    .doc p { margin: 8px 0; }
    .sigrow { display:flex; gap: 16px; align-items:flex-end; }
    .sigbox { width: 340px; }
    .sigimg { border: 1px solid #111; height: 90px; border-radius: 6px; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .sigimg img { max-height: 88px; max-width: 330px; }
    .line { border-top: 1px solid #111; margin-top: 8px; padding-top: 6px; }
    .label { font-weight: 700; }
    a { color:#111; text-decoration:none; }
  </style>
</head>

<body>
  <div class="header">
    <div class="brand">LumenNyx Studios — Executed Legal Document</div>
    <div class="meta">
      Document: <strong><%= template ? template.title : '—' %></strong>
      · Version: <strong><%= template ? template.version : '—' %></strong>
      · Slug: <strong><%= template ? template.slug : '—' %></strong>
    </div>
    <div class="meta">
      Generated: <strong><%= (audit && audit.signedAtIso) ? audit.signedAtIso : new Date().toISOString() %></strong>
    </div>
  </div>

  <div class="section box">
    <div class="small">
      <span class="label">Studio Contact:</span>
      <%= (studioEmails && (studioEmails.admin || studioEmails.booking || studioEmails.general)) ? (studioEmails.admin || studioEmails.booking || studioEmails.general) : '—' %>
    </div>
    <div class="small" style="margin-top:4px;">
      <span class="label">Signer (User):</span>
      <%= (payload && payload.signer && payload.signer.username) ? payload.signer.username : '—' %>
      (ID: <%= (payload && payload.signer && payload.signer.userId) ? payload.signer.userId : '—' %>)
    </div>
  </div>

  <div class="section box doc">
    <!-- Render the stored HTML body -->
    <%- template && template.body_html ? template.body_html : '<p>No document body found.</p>' %>
  </div>

  <div class="section box">
    <div class="sigrow">
      <div class="sigbox">
        <div class="label">Signature</div>
        <div class="sigimg">
          <% if (signature && signature.signature_data_url) { %>
            <img src="<%= signature.signature_data_url %>" alt="Signature" />
          <% } else { %>
            <div class="small">Signature image not available</div>
          <% } %>
        </div>
        <div class="line small">
          Signed Name: <strong><%= signature ? (signature.typed_name || '—') : '—' %></strong>
        </div>
      </div>

      <div style="flex:1;">
        <div class="label">Audit Trail</div>
        <div class="small" style="margin-top: 6px;">
          IP: <strong><%= audit ? (audit.ip || '—') : '—' %></strong><br/>
          User Agent: <strong><%= audit ? (audit.ua || '—') : '—' %></strong><br/>
          Signed At: <strong><%= audit ? (audit.signedAtIso || '—') : '—' %></strong>
        </div>

        <div class="hr"></div>

        <div class="small">
          This PDF is a generated record of the executed agreement for internal compliance and recordkeeping.
        </div>
      </div>
    </div>
  </div>
</body>
</html>
