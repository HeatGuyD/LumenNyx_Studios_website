<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Signature Setup – LumenNyx Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <header class="site-header">
    <div class="site-header-inner">
      <a href="/" class="brand-link">
        <span class="brand-text">LUMENNYX STUDIOS</span>
      </a>
      <nav class="main-nav">
        <a href="/model/profile">Profile</a>
        <a href="/model/release">Release</a>
        <form action="/logout" method="POST" style="display:inline;">
          <button class="btn secondary" style="padding:0.25rem 0.9rem;font-size:0.8rem;">Logout</button>
        </form>
      </nav>
    </div>
  </header>

  <main class="container" style="max-width: 980px;">
    <h1>Signature Setup</h1>
    <p class="muted">
      You can sign either by typing your name (rendered as a signature-style image) or by drawing your signature.
      Your signature is stored and applied to documents you sign in the portal.
    </p>

    <% if (signature) { %>
      <div class="notice success">
        A signature is already on file (created <%= signature.created_at %>). You can replace it below.
      </div>
    <% } %>

    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert error"><%= error %></div>
    <% } %>

    <% if (typeof message !== 'undefined' && message) { %>
      <div class="alert success"><%= message %></div>
    <% } %>

    <form id="sigForm" action="/model/signature" method="POST" class="card">
      <input type="hidden" name="method" id="method" value="typed" />
      <input type="hidden" name="typed_style" id="typed_style" value="style1" />
      <input type="hidden" name="signature_data_url" id="signature_data_url" />
      <input type="hidden" name="initials_data_url" id="initials_data_url" />

      <!-- Add-only: optional audit metadata (safe if backend ignores) -->
      <input type="hidden" name="client_tz" id="client_tz" value="" />

      <div class="tabs">
        <button type="button" class="tab active" data-tab="typed">Type signature</button>
        <button type="button" class="tab" data-tab="draw">Draw signature</button>
      </div>

      <section id="tab-typed" class="tab-panel active">
        <label>
          Legal name (required)
          <input
            type="text"
            name="typed_name"
            id="typed_name"
            placeholder="First Last"
            required
            value="<%=
              (profile && profile.legal_name) ? profile.legal_name :
              (signature && signature.typed_name) ? signature.typed_name :
              ''
            %>"
          />
        </label>

        <div style="margin-top: 12px;">
          <div class="muted" style="margin-bottom: 8px;">Choose a style:</div>
          <div class="sig-style-row">
            <button type="button" class="sig-style active" data-style="style1"
              style="font-family: 'Brush Script MT', 'Segoe Script', cursive;">Signature Style 1</button>
            <button type="button" class="sig-style" data-style="style2"
              style="font-family: 'Segoe Script', 'Lucida Handwriting', cursive;">Signature Style 2</button>
            <button type="button" class="sig-style" data-style="style3"
              style="font-family: 'Lucida Handwriting', 'Comic Sans MS', cursive;">Signature Style 3</button>
          </div>
        </div>

        <div class="sig-preview">
          <canvas id="typedCanvas" width="900" height="220"></canvas>
        </div>

        <div class="muted" style="margin-top: 10px;">
          Initials will be generated automatically from your name.
        </div>
      </section>

      <section id="tab-draw" class="tab-panel">
        <div class="muted" style="margin-bottom: 8px;">Draw your signature in the box below.</div>
        <div class="sig-preview">
          <canvas id="drawCanvas" width="900" height="220"></canvas>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px;">
          <button type="button" class="btn" id="clearDraw">Clear</button>
          <button type="button" class="btn" id="useDrawAsInitials">Use drawn initials box</button>
        </div>
        <div class="muted" style="margin-top: 10px;">
          If you click “Use drawn initials box”, you can draw initials separately (optional). Otherwise, initials are omitted.
        </div>

        <div id="initialsBoxWrap" style="display:none; margin-top: 14px;">
          <div class="muted" style="margin-bottom: 8px;">Draw initials:</div>
          <div class="sig-preview">
            <canvas id="initialsCanvas" width="450" height="180"></canvas>
          </div>
          <button type="button" class="btn" id="clearInitials" style="margin-top: 10px;">Clear initials</button>
        </div>
      </section>

      <div style="display:flex; gap:12px; margin-top: 16px; justify-content:flex-end;">
        <a class="btn secondary" href="/model/profile">Cancel</a>
        <button class="btn primary" type="submit">Save signature</button>
      </div>
    </form>
  </main>

  <script src="/js/signature.js"></script>

  <!-- Add-only: defensive glue so posts always contain usable fields -->
  <script>
    (function () {
      // Timezone (audit)
      try {
        var tz = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
        var tzEl = document.getElementById('client_tz');
        if (tzEl) tzEl.value = tz;
      } catch (e) {}

      var form = document.getElementById('sigForm');
      var methodEl = document.getElementById('method');
      var typedStyleEl = document.getElementById('typed_style');
      var typedNameEl = document.getElementById('typed_name');
      var sigUrlEl = document.getElementById('signature_data_url');
      var initUrlEl = document.getElementById('initials_data_url');

      var tabButtons = document.querySelectorAll('.tabs .tab');
      var tabPanels = {
        typed: document.getElementById('tab-typed'),
        draw: document.getElementById('tab-draw')
      };

      function setActiveTab(tab) {
        // Update hidden method
        if (methodEl) methodEl.value = tab;

        // UI active state (kept minimal; your CSS likely handles this)
        tabButtons.forEach(function (btn) {
          var is = (btn.getAttribute('data-tab') === tab);
          btn.classList.toggle('active', is);
        });
        if (tabPanels.typed) tabPanels.typed.classList.toggle('active', tab === 'typed');
        if (tabPanels.draw) tabPanels.draw.classList.toggle('active', tab === 'draw');
      }

      tabButtons.forEach(function (btn) {
        btn.addEventListener('click', function () {
          var tab = btn.getAttribute('data-tab');
          if (tab === 'typed' || tab === 'draw') setActiveTab(tab);
        });
      });

      // Style buttons should update hidden typed_style reliably
      var styleButtons = document.querySelectorAll('.sig-style-row .sig-style');
      styleButtons.forEach(function (btn) {
        btn.addEventListener('click', function () {
          var style = btn.getAttribute('data-style') || 'style1';
          if (typedStyleEl) typedStyleEl.value = style;

          styleButtons.forEach(function (b) { b.classList.toggle('active', b === btn); });

          // Nudge signature.js to redraw if it listens to input events
          if (typedNameEl) typedNameEl.dispatchEvent(new Event('input', { bubbles: true }));
        });
      });

      // On load: if typed name prefilled, trigger render in signature.js
      if (typedNameEl && typedNameEl.value) {
        try { typedNameEl.dispatchEvent(new Event('input', { bubbles: true })); } catch (e) {}
      }

      // Submit validation: ensure we aren't storing blank signature data
      if (form) {
        form.addEventListener('submit', function (e) {
          var method = (methodEl && methodEl.value) ? methodEl.value : 'typed';

          // In typed mode, we expect signature_data_url to be present.
          // In draw mode, we also expect signature_data_url (from drawn canvas).
          var sigOk = sigUrlEl && sigUrlEl.value && sigUrlEl.value.indexOf('data:image') === 0;

          if (!sigOk) {
            e.preventDefault();
            alert(
              "Signature image data is missing. Please type your name or draw your signature until it appears in the preview, then try again."
            );
            return false;
          }

          // Initials are optional; if empty, leave it blank (backend can store null/empty).
          // If present but invalid, wipe it to avoid storing garbage.
          if (initUrlEl && initUrlEl.value && initUrlEl.value.indexOf('data:image') !== 0) {
            initUrlEl.value = '';
          }

          // If user is on draw tab, typed_name is still required by HTML; keep it valid:
          // If empty (rare), attempt to fall back to profile legal name already prefilled, else block.
          if (method === 'draw' && typedNameEl && !typedNameEl.value) {
            e.preventDefault();
            alert("Please enter your legal name before saving your signature.");
            return false;
          }
        });
      }
    })();
  </script>
</body>
</html>
